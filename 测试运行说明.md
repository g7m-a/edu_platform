# 测试运行说明

## 一、测试环境

- **测试框架**：Jest 30.2.0
- **测试位置**：`server/__tests__/` 目录
- **测试配置文件**：`server/jest.config.js`

---

## 二、运行测试的方法

### 方法1：使用 npm 脚本（推荐）

#### 1. 进入后端目录
```bash
cd server
```

#### 2. 运行所有测试
```bash
npm test
```

#### 3. 运行测试并生成覆盖率报告
```bash
npm run test:coverage
```

#### 4. 监视模式运行测试（自动重新运行）
```bash
npm run test:watch
```

---

### 方法2：直接使用 Jest 命令

#### 1. 进入后端目录
```bash
cd server
```

#### 2. 运行所有测试
```bash
npx jest
```

#### 3. 运行特定测试文件
```bash
npx jest homework-publish-validation.test.js
```

#### 4. 运行测试并生成覆盖率报告
```bash
npx jest --coverage
```

#### 5. 监视模式
```bash
npx jest --watch
```

---

## 三、测试文件列表

项目包含以下测试文件（共6个测试文件，29个测试用例）：

1. **`file-upload.test.js`** - 文件上传验证测试（4个测试用例）
   - 测试文件类型验证
   - 测试文件大小限制
   - 测试唯一文件名生成

2. **`file-extraction.test.js`** - 文件内容提取测试（3个测试用例）
   - 测试文件扩展名识别
   - 测试不支持格式处理

3. **`homework-publish-validation.test.js`** - 作业发布验证测试（5个测试用例）
   - 测试课程时间验证逻辑
   - 测试边界情况处理

4. **`ai-json-parsing.test.js`** - AI JSON解析测试（7个测试用例）
   - 测试AI响应JSON解析
   - 测试数据验证（分数范围、评语长度）

5. **`transaction-order.test.js`** - 数据库事务处理测试（5个测试用例）
   - 测试级联删除顺序
   - 测试事务原子性

6. **`parameter-validation.test.js`** - 参数验证测试（5个测试用例）
   - 测试必填参数验证
   - 测试数据格式验证

---

## 四、详细运行步骤

### 步骤1：确保依赖已安装

```bash
# 进入后端目录
cd server

# 安装依赖（如果还没安装）
npm install
```

### 步骤2：运行测试

#### 方式A：运行所有测试
```bash
npm test
```

**预期输出**：
```
PASS  __tests__/file-upload.test.js
PASS  __tests__/file-extraction.test.js
PASS  __tests__/homework-publish-validation.test.js
PASS  __tests__/ai-json-parsing.test.js
PASS  __tests__/transaction-order.test.js
PASS  __tests__/parameter-validation.test.js

Test Suites: 6 passed, 6 total
Tests:       29 passed, 29 total
```

#### 方式B：运行测试并查看覆盖率
```bash
npm run test:coverage
```

**预期输出**：
- 测试结果
- 代码覆盖率报告（文本格式）
- 覆盖率报告文件（HTML格式，保存在 `coverage/` 目录）

#### 方式C：监视模式（开发时使用）
```bash
npm run test:watch
```

**特点**：
- 自动监视文件变化
- 文件保存后自动重新运行相关测试
- 适合开发时使用

---

## 五、运行特定测试

### 运行单个测试文件

```bash
# 进入后端目录
cd server

# 运行特定测试文件
npx jest homework-publish-validation.test.js
```

### 运行匹配名称的测试

```bash
# 运行所有包含 "validation" 的测试
npx jest --testNamePattern="validation"
```

### 运行特定测试用例

```bash
# 运行测试用例名称包含 "应该拒绝" 的测试
npx jest --testNamePattern="应该拒绝"
```

---

## 六、查看测试覆盖率

### 生成覆盖率报告

```bash
cd server
npm run test:coverage
```

### 查看覆盖率报告

1. **终端输出**：运行后会在终端显示文本格式的覆盖率报告
2. **HTML报告**：打开 `server/coverage/lcov-report/index.html` 查看详细的HTML报告

**覆盖率报告包含**：
- 语句覆盖率（Statements）
- 分支覆盖率（Branches）
- 函数覆盖率（Functions）
- 行覆盖率（Lines）

---

## 七、常见问题

### 问题1：找不到 jest 命令

**解决方案**：
```bash
# 确保在 server 目录下
cd server

# 安装依赖
npm install

# 使用 npx 运行
npx jest
```

### 问题2：测试超时

**原因**：某些测试可能需要较长时间（如数据库操作）

**解决方案**：
- 测试超时时间已设置为 30 秒（在 `jest.config.js` 中配置）
- 如果仍然超时，可以增加超时时间

### 问题3：测试失败

**检查步骤**：
1. 查看错误信息，确定是哪个测试失败
2. 检查测试文件中的测试逻辑
3. 检查被测试的代码是否有变更
4. 确保数据库连接正常（如果有数据库相关测试）

---

## 八、测试输出示例

### 成功运行示例

```
 PASS  __tests__/file-upload.test.js
 文件上传验证
   ✓ 应该接受有效的文件类型 (2 ms)
   ✓ 应该拒绝无效的文件类型 (1 ms)
   ✓ 应该验证文件大小限制 (1 ms)
   ✓ 应该生成唯一的文件名 (1 ms)

 PASS  __tests__/homework-publish-validation.test.js
 作业发布验证
   ✓ 应该拒绝在课程结束后发布作业 (1 ms)
   ✓ 应该允许在课程进行期间发布作业 (1 ms)
   ✓ 应该拒绝在课程开始前发布作业 (1 ms)
   ✓ 应该处理没有时间限制的课程 (1 ms)
   ✓ 应该正确处理边界情况（课程结束当天） (1 ms)

Test Suites: 6 passed, 6 total
Tests:       29 passed, 29 total
Snapshots:   0 total
Time:        2.345 s
```

### 覆盖率报告示例

```
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
-------------------|---------|----------|---------|---------|-------------------
All files          |   85.23 |    78.45 |   82.10 |   85.23 |
 server.js         |   85.23 |    78.45 |   82.10 |   85.23 | 123,456,789
-------------------|---------|----------|---------|---------|-------------------
```

---

## 九、快速开始

**最简单的运行方式**：

```bash
# 1. 进入后端目录
cd server

# 2. 运行所有测试
npm test
```

**查看详细覆盖率**：

```bash
# 1. 进入后端目录
cd server

# 2. 运行测试并生成覆盖率报告
npm run test:coverage

# 3. 打开覆盖率报告（可选）
# Windows:
start coverage/lcov-report/index.html
# Mac:
open coverage/lcov-report/index.html
# Linux:
xdg-open coverage/lcov-report/index.html
```

---

## 十、总结

| 命令 | 说明 | 使用场景 |
|------|------|----------|
| `npm test` | 运行所有测试 | 日常测试 |
| `npm run test:coverage` | 运行测试并生成覆盖率报告 | 查看代码覆盖率 |
| `npm run test:watch` | 监视模式运行测试 | 开发时自动测试 |
| `npx jest <文件名>` | 运行特定测试文件 | 调试单个测试 |

**推荐流程**：
1. 开发新功能时：使用 `npm run test:watch` 自动测试
2. 提交代码前：使用 `npm test` 确保所有测试通过
3. 定期检查：使用 `npm run test:coverage` 查看覆盖率
